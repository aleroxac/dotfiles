#!/usr/bin/env python3

from pathlib import Path
from yaml import load, dump
from yaml.loader import SafeLoader

kubeconfig_path = str(Path.home()) + "/.kube/configs"
kubeconfig_pattern = "*.yaml"
kubeconfig_files_in_path = Path(kubeconfig_path).glob(kubeconfig_pattern)
kubeconfig_files_list = [ str(file) for file in kubeconfig_files_in_path if file.is_file() ]

clusters, contexts, users = [], [], []
for kubeconfig in kubeconfig_files_list:
    with open(kubeconfig, "r", encoding="utf-8") as kubeconfig_file:
        kubeconfig_content = load(kubeconfig_file, Loader=SafeLoader)
        clusters += kubeconfig_content["clusters"]
        contexts += kubeconfig_content["contexts"]
        users += kubeconfig_content["users"]

main_kubeconfig_file = Path(f"{kubeconfig_path}/config.yaml")
if main_kubeconfig_file.exists():
    main_kubeconfig_file.unlink()

with open(f"{kubeconfig_path}/config.yaml", "w", encoding="utf-8") as kubeconfig_file:
    kubeconfig_content = {
        "apiVersion": "v1",
        "kind": "Config",
        "preferences": {},
        "current-context": contexts[0]["name"],
        "clusters": clusters,
        "users": users,
        "contexts": contexts
    }
    dump(kubeconfig_content, kubeconfig_file, sort_keys=False, indent=2)
main_kubeconfig_file.chmod(0o600)
